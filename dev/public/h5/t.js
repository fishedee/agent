function _get(a){var b=new RegExp("(^|&)"+a+"=([^&]*)(&|$)","i"),c=window.location.search.substr(1).match(b);return null!=c?unescape(c[2]):""}function _hash(){return""==location.hash?"message":location.hash.substr(1)}function parse(data){var dataObj=eval("("+data+")");return dataObj}function load(){$(".page").hide(),$(".gb-nav li").removeClass("cur"),page=_hash(),$("#page-"+page).show(),$("#nav-"+page).addClass("cur"),"message"==page?(pageFrom=0,$("#message-list").empty(),get_message_list(),$("#page-message .refresh-bar").bind("click"),$("#page-message .refresh-bar").click(function(a){return $(this).hide(),pageFrom+=pageSize,get_message_list(),a.stopPropagation(),!1}),$("#page-message .action.flex .btn").unbind("click"),$("#page-message .action.flex .btn").click(function(a){return $("#message-list").empty(),$("#page-message .action.flex .btn").removeClass("active"),$(this).addClass("active"),pageFrom=0,console.log(1),get_message_list(),a.stopPropagation(),a.preventDefault(),!1})):"project"==page?(pageFrom=0,$("#project-list").empty(),get_project_list(),$("#page-project .refresh-bar").unbind("click"),$("#page-project .refresh-bar").click(function(a){return $(this).hide(),pageFrom+=pageSize,get_project_list(),a.stopPropagation(),!1})):"customer"==page?(pageFrom=0,$("#customer-list").empty(),get_customer_list(),$("#page-customer #search").unbind("click"),$("#page-customer #search").click(function(a){var b=$("#page-customer #search_phoneNumber").val();return $("#customer-list").empty(),get_customer_list(b),a.stopPropagation(),!1}),$("#page-customer .refresh-bar").unbind("click"),$("#page-customer .refresh-bar").click(function(a){$(this).hide(),pageFrom+=pageSize;var b=$("#page-customer #search_phoneNumber").val();return get_customer_list(b),a.stopPropagation(),!1}),$("#page-customer .action.flex .btn").unbind("click"),$("#page-customer .action.flex .btn").click(function(a){return $("#customer-list").empty(),$("#page-customer .action.flex .btn").removeClass("active"),$(this).addClass("active"),pageFrom=0,get_customer_list(),a.stopPropagation(),!1}),$.get("/json.php/MiddleMan/AddDealRequest",{userId:userId},function(a){$("#addcustomer-area").empty(),$("#addcustomer-budget").empty();var a=parse(a);return 0!=a.retCode?($("#addcustomer-submit").attr("disabled","disabled"),$("#addcustomer-submit").parent().css("background","#ccc"),$(".add_customer").parent().css("background","#ccc"),$(".add_customer").attr("disabled","disabled"),void $("#page-customer .add_customer").unbind("click")):void $("#page-customer .add_customer").click(function(a){return location.href="#addcustomer",a.stopPropagation(),!1})})):"addcustomer"==page?($("#nav-customer").addClass("cur"),$(".b-bak").click(function(a){return location.href="#customer",a.stopPropagation(),!1}),$.get("/json.php/MiddleMan/AddDealRequest",{userId:userId},function(a){$("#addcustomer-area").empty(),$("#addcustomer-budget").empty();var a=parse(a);if(0!=a.retCode)return $("#addcustomer-submit").attr("disabled","disabled"),$("#addcustomer-submit").parent().css("background","#ccc"),void(location.href="#customer");var b=a.data.areaList,c=a.data.budgetList,d="<option value='NULL'>请选择面积</option>";$("#addcustomer-area").append(d);for(var e in b){var d="<option value='"+b[e]+"'>"+b[e]+"</option>";$("#addcustomer-area").append(d)}var d="<option value='NULL'>请选择预算</option>";$("#addcustomer-budget").append(d);for(var e in c){var d="<option value='"+c[e]+"'>"+c[e]+"</option>";$("#addcustomer-budget").append(d)}}),pageFrom=0,get_project_option(),$("#addcustomer-submit").unbind("click"),$("#addcustomer-submit").click(add_customer)):"user"==page?(pageFrom=0,get_user_info()):"detail"==page&&($("#nav-customer").addClass("cur"),pageFrom=0,get_detail_info())}function get_project_list(){$.get("/json.php/MiddleMan/GetProjectList",{userId:userId,pageFrom:-1,pageSize:pageSize},function(a){var a=parse(a);if(0!=a.retCode)return void alert(a.retMessage);var b=a.data;for(var c in b){var d=sprintf(project_feed,b[c].infoUrl,b[c].title,b[c].createTime,b[c].pictureUrl,b[c].description);$("#project-list").append(d)}pageFrom<a.count&&$("#page-project .refresh-bar").show()})}function get_message_list(){var a=$("#page-message .btn.active").attr("data");$.get("/json.php/MiddleMan/GetMessageList",{userId:userId,type:a,pageFrom:pageFrom,pageSize:pageSize},function(a){var a=parse(a);if(0!=a.retCode)return void alert(a.retMessage);var b=a.data;for(var c in b){var d=sprintf(message_feed,b[c].createTime,b[c].message);$("#message-list").append(d)}pageFrom<a.count&&$("#page-message .refresh-bar").show()})}function get_customer_list(a){void 0==a&&(a=""),$.get("/json.php/MiddleMan/GetDealList",{userId:userId,pageFrom:pageFrom,pageSize:pageSize,phoneNumber:a},function(a){var a=parse(a);if(0!=a.retCode)return void alert(a.retMessage);var b=a.data;for(var c in b){b[c].limitTime="面积:"+b[c].area+" 预算:"+b[c].budget;var d=sprintf(customer_feed,b[c].dealId,b[c].name,b[c].phoneNumber,b[c].projectName,b[c].limitTime,b[c].stateName);$("#customer-list").append(d)}pageFrom<a.count&&$("#page-customer .refresh-bar").show()})}function get_project_option(){$.get("/json.php/MiddleMan/GetProjectList",{userId:userId},function(a){var a=parse(a);if(0!=a.retCode)return void alert(a.retMessage);$("#addcustomer-project").empty();var b=a.data,c="";for(var d in b)c+="<option value='"+b[d].projectId+"'>"+b[d].title+"</option>";$("#addcustomer-project").append(c)})}function addcustomer_success(a){var b=sprintf(addcustomer_feed,a.tips,a.beg_time,a.end_time);$("#addcustomer-result").html(b),$("#addcustomer-viewpage").show(),$("#addcustomer-addpage").hide()}function reset_customer(){$("#addcustomer-project").val("NULL"),$("#addcustomer-name").val(""),$("#addcustomer-phone").val(""),$("#addcustomer-area").val(""),$("#addcustomer-budget").val(""),$("#addcustomer-viewpage").hide(),$("#addcustomer-addpage").show()}function add_customer(){var a={};return a.userId=userId,a.name=$("#addcustomer-name").val(),a.projectId=$("#addcustomer-project").val(),a.project=$("#addcustomer-project").val(),a.projectName=$("select#addcustomer-project option[value='"+a.projectId+"']").text(),a.phoneNumber=$("#addcustomer-phone").val(),a.area=$("#addcustomer-area").val(),a.budget=$("#addcustomer-budget").val(),""==a.name?void alert("请输入客户名称"):"NULL"==a.projectId?void alert("请选择楼盘信息"):""==a.phoneNumber?void alert("请输入客户手机号码"):"NULL"==a.area?void alert("请选择面积"):"NULL"==a.budget?void alert("请选择预算"):($("#addcustomer-submit").unbind("click"),$("#addcustomer-submit").attr("disabled","disabled"),$("#addcustomer-submit").parent().css("background","#ccc"),void $.post("/json.php/MiddleMan/AddDeal",a,function(a){var a=parse(a);return 0!=a.retCode?(alert(a.retMessage),void(location.href="#customer")):(iosOverlay({text:"添加成功",duration:2e3,icon:"img/check.png",onhide:function(){location.href="#customer"}}),$("#addcustomer-submit").parent().css("background","#0044cc"),$("#addcustomer-submit").attr("disabled",null),$("#addcustomer-name").val(""),void $("#addcustomer-phone").val(""))}))}function get_user_info(){$.get("/json.php/MiddleMan/GetDealAchievement",{userId:userId},function(a){var a=parse(a);return 0!=a.retCode?void alert(a.retMessage):(a=a.data,$("#report").text(a.ClientHaveReport),$("#look").text(a.ClientHaveLook),$("#pledge").text(a.ClientHavePledge),$("#deal").text(a.ClientHaveDeal),$("#payready").text(a.ClientPayReady),$("#requestpay").text(a.RequestPay),$("#havepay").text(a.HavePay),$("#cpaying").text(a.ClientPaying),void $("#chavepay").text(a.ClientHavePay))})}function get_detail_info(){return dealId=$(".feed.dataItem.active").attr("data"),dealId&&""!=dealId?($.get("/json.php/MiddleMan/GetDealInfo",{userId:userId,dealId:dealId},function(a){var a=JSON.parse(a);if(0!=a.retCode)return void alert(a.retMessage);a=a.data,$("#contact_customer").attr("href","tel:"+a.phoneNumber),$("#detail-name").text(a.name),$("#detail-project").text(a.projectName),$("#detail-timeline").empty();var b=a.stateInfo,c="";for(var d in b)c+=sprintf(detail_feed,b[d].stateName,b[d].createTime);$("#detail-timeline").append(c)}),void $("#appeal .btn").click(function(){var a=$(this).text(),b=$(this);"提交"==a?($.post("/json.php/MiddleMan/AddDealAppeal",{userId:userId,dealId:dealId,message:$(".text-area").val()},function(){iosOverlay({text:"操作成功",duration:2e3,icon:"img/check.png"}),$(".text-area").hide()}),b.text("申诉")):($(".text-area").show(),b.text("提交"))})):void(location.href="#customer")}function click_customer_detail(a){$(a).addClass("active"),location.href="#detail",$("#sub_back").click(function(){location.href="#customer"})}var page="message",pageFrom=0,pageSize=5,userId=_get("userId"),dealId="",overlay=[];$(document).on("ajaxBeforeSend",function(){var a={lines:13,width:5,radius:17,corners:1,rotate:0,color:"#FFF",speed:1,trail:60,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},b=document.createElement("div");document.body.appendChild(b);var c=new Spinner(a).spin(b);overlay.push(iosOverlay({text:"拼命加载中...",spinner:c}))}),$(document).on("ajaxSuccess",function(){var a=0;for(a=overlay.length;a>1;a--)b=overlay[a-1],b.hide();if(overlay.length>0){var b=overlay.pop();window.setTimeout(function(){b.hide()},500)}}),window.onhashchange=load;var project_feed='<div class="feed dataItem" onclick="location.href=\'%s\'"><div class="hd">	<p class="info ">	<span class="title">%s</span><span class="meta" style="float:right"><time class="time">%s</time></span>	</p></div><div class="bd">	<p class="img loaded">	<img style="max-width: 320px" src="%s" /></p>	<p class="description">%s</p></div></div>',message_feed='<div class="feed dataItem"><div class="hd"><h3 class="info "><span class="state">%s</span></h3></div><div class="bd"><p style="font-size: 12px; color:#777;"><img style="max-width: 320px" src="/public/h5/img/message.png" class="mini-em"> %s</p></div>',customer_feed='<div data="%s" onclick="click_customer_detail(this)" class="feed dataItem"><div class="hd"><p class="info "><span class="title">%s(%s)</span><span class="meta" style="float:right"><time class="time">%s</time></span></p></div><div class="hd"><p class="description">%s</p><p class="info "><span class="meta" style="float:right;background:#ddd">%s</span></p></div></div>',addcustomer_feed="<div >%s<br>可带看时间：%s<br>失效时间：%s</div>",detail_feed='<li><h3>%s</h3><dl class="right"><span>%s</span></dl></li>';