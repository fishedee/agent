BUI.use(["bui/menu","bui/tab"],function(a,b){function c(a){window.topManager=a}function d(a,b){return-1!==a.indexOf("?")?a+"&"+b:a+"?"+b}function e(c,d,e,g,h){var i=this,j=new a.SideMenu(e),k=new b.NavTab(d),l=$(e.render),m=l.next("."+s+"-con"),n=l.parents("."+t);m&&(m.on("click",function(){n.toggleClass(u)}),m.parent().height(d.height)),g&&n.addClass(u),j.on("menuclick",function(a){var b=a.item;b&&i.tab.addTab({id:b.get("id"),title:b.get("text"),href:b.get("href"),closeable:b.get("closeable")},!0)}),j.on("itemselected",function(a){var b=a.item;b&&f(c,b.get("id"))}),k.on("activeChange",function(a){var b=a.item;b?i.menu.setSelectedByField(b.get("id")):i.menu.clearSelection()}),i.tab=k,i.menu=j,i.homePage=h,k.render(),j.render()}function f(a,b){b=b||"";var c="#"+a;b&&(c+="/"+b),location.hash=c}function g(){var a=location.hash,b=0,c="",d=a.indexOf("/"),e=null;return a?(d>=0?(b=a.substring(1,d),c=a.substring(d+1),e=h(c),e&&(c=c.replace("?"+e,""))):b=a.substring(1),{moduleId:b,pageId:c,search:e}):null}function h(a){var b=a.indexOf("?");return b>=0?a.substring(b+1):null}function i(a){if($.isArray(a)){for(var b=j(a);-1!==b;)a.splice(b,1),b=j(a);return a}}function j(a){var b=-1;return $.each(a,function(a,c){return null===c||void 0===c?(b=a,!1):void 0}),b}function k(){var a=BUI.viewportHeight(),b=70;return a-b}function l(a){var b=$(a);return b.hasClass(r)?a:b.parent("."+r)[0]}var m=BUI.app("PageUtil"),n="dl-selected",o="ks-hidden",p="dl-last",q="dl-hover",r="nav-item",s="dl-second-slib",t="dl-tab-item",u="dl-collapse",v="dl-hide-current",w="data-index",x=145,y=function(a){i(a),y.superclass.constructor.call(this,a),this._init(),c(this)};y.ATTRS={currentModelIndex:{},hideItmes:{value:[]},hideList:{},modules:{value:[]},modulesConfig:{},navList:{valueFn:function(){return $("#J_Nav")}},navContent:{valueFn:function(){return $("#J_NavContent")}},navItems:{valueFn:function(){return $("#J_Nav").children("."+r)}},navTabs:{valueFn:function(){return this.get("navContent").children("."+t)}},urlSuffix:{value:".html"}},BUI.extend(y,BUI.Base),BUI.augment(y,{openPage:function(a){var b=this,c=a.moduleId||b._getCurrentModuleId(),d=a.id,e=a.title||"新的标签页",f=a.href,g=a.isClose,h=a.closeable,i=a.reload,j=a.search,k=b._getModule(c);if(k){var l=k.tab,m=k.menu,n=m.getItem(d),o=l.getActivedItem(),p=o?o.get("id"):null,q=b._getModuleIndex(c);c!=b._getCurrentModuleId()&&b._setModuleSelected(q),n?b._setPageSelected(q,d,i,j):l.addTab({id:d,title:e,href:f,sourceId:p,closeable:h},i),g&&o.close()}},closePage:function(a,b){this.operatePage(b,a,"close")},reloadPage:function(a,b){this.operatePage(b,a,"reload")},setPageTitle:function(a,b,c){this.operatePage(c,b,"setTitle",[a])},operatePage:function(a,b,c,d){a=a||this._getCurrentModuleId(),d=d||[];var e=this,f=e._getModule(a);if(f){var g=f.tab,h=b?g.getItemById(b):g.getActivedItem();h&&h[c]&&h[c].apply(h,d)}},_createModule:function(a){var b=this,c=b._getModuleConfig(a),d=b.get("modules");if(!c)return null;var a=c.id,f="#J_"+a+"Tab",g="#J_"+a+"Tree";return module=new e(a,{render:f,height:k()-5},{render:g,items:c.menu,height:k()-5},c.collapsed,c.homePage),d[a]=module,module},_hideHideList:function(){this.get("hideList").hide()},_init:function(){var a=this;a._initDom(),a._initNavItems(),a._initEvent()},_initNavItems:function(){var a=this,b=a.get("navItems"),c=a.get("hideItmes");if(0!==b.length){$('<div class="nav-item-mask"></div>').appendTo($(b));var d=b.length,e=BUI.viewportWidth(),f=x,g=f*d,h=0;if(!(e>=g)){$.each(b,function(a,b){$(b).attr(w,a),$(b).removeClass(p)}),h=parseInt(e/f);var i=b[h-1];a._setLastItem(i),c.push($(i).clone()[0]);for(var j=h;d>j;j++){var k=$(b[j]),l=null;l=k.clone()[0],c.push(l),k.addClass(o)}a._initHideList()}}},_initHideList:function(){var a=this,b=a.get("hideList"),c=a.get("hideItmes");if(!b){var d='<ul class="dl-hide-list ks-hidden"></ul>',e=$(d).appendTo("body");b=e,$.each(c,function(a,c){$(c).appendTo(b)}),a.set("hideList",b),a._initHideListEvent()}},_initHideListEvent:function(){var a=this,b=a.get("hideList");null!=b&&(b.on("mouseleave",function(){a._hideHideList()}),b.on("click",function(b){var c=l(b.target),d=null,e=0;c&&(d=$(c),e=d.attr(w),a._setModuleSelected(e),a._hideHideList())}))},_initContents:function(){var a=this,b=a.get("modulesConfig"),c=a.get("navContent");c.children().remove(),$.each(b,function(a,b){var d=b.id,e=['<li class="dl-tab-item ks-hidden"><div class="dl-second-nav"><div class="dl-second-tree" id="J_',d,'Tree"></div><div class="',s,'-con"><div class="',s,'"></div></div></div><div class="dl-inner-tab" id="J_',d,'Tab"></div></li>'].join("");new $(e).appendTo(c)})},_initDom:function(){var a=this;a._initContents(),a._initLocation()},_initEvent:function(){var a=this,b=a.get("navItems");b.each(function(b,c){var c=$(c);c.on("click",function(){var c=$(this);c.hasClass(n)||a._setModuleSelected(b,c)}).on("mouseenter",function(){$(this).addClass(q)}).on("mouseleave",function(){$(this).removeClass(q)})}),a._initNavListEvent()},_initNavListEvent:function(){var a=this,b=a.get("hideList"),c=a.get("navList");c.on("mouseover",function(c){var d=l(c.target),e=$(d),f=null;e&&e.hasClass(p)&&b&&(f=e.offset(),f.top+=37,f.left+=2,a._showHideList(f))}).on("mouseout",function(c){var d=c.toElement;d&&b&&!$.contains(b[0],d)&&d!==b[0]&&a._hideHideList()})},_initLocation:function(){var a=this,b=g();if(b){var c=b.pageId,d=b.search,e=a._getModuleIndex(b.moduleId);a._setModuleSelected(e),a._setPageSelected(e,c,!0,d)}else{var h=a.get("currentModelIndex"),i=a._getModuleId(h);null==h?a._setModuleSelected(0):f(i)}},_getModule:function(a){var b=this,c=b.get("modules")[a];return c||(c=b._createModule(a)),c},_getModuleIndex:function(a){var b=this,c=0;return $.each(b.get("modulesConfig"),function(b,d){return d.id===a?(c=b,!1):void 0}),c},_getModuleConfig:function(a){var b=this,c=null;return $.each(b.get("modulesConfig"),function(b,d){return d.id===a?(c=d,!1):void 0}),c},_getModuleId:function(a){var b=this.get("modulesConfig");return b[a]?b[a].id:a},_getCurrentPageId:function(){var a=this,b=a._getCurrentModuleId(),c=a._getModule(b),d="";if(c){var e=c.menu.getSelected();e&&(d=e.get("id"))}return d},_getCurrentModuleId:function(){return this._getModuleId(this.get("currentModelIndex"))},_isModuleInitial:function(a){return!!this.get("modules")[a]},_setLastItem:function(a){var b=this,c=b.get("lastShowItem");if(c!==a){var d=null,e=$(c);itemEl=$(a),c&&(d=e.find("."+v),e.removeClass(p),e.addClass(o)),itemEl.addClass(p),itemEl.removeClass(o),d||(d=$('<span class="icon icon-white  icon-caret-down '+v+'">&nbsp;&nbsp;</span>')),d.appendTo(itemEl.children(".nav-item-inner")),b.set("lastShowItem",a)}},_setModuleSelected:function(a,b){var c=this,d=c.get("navItems"),e=c.get("navTabs"),g=c.get("currentModelIndex");if(g!==a){var h=c._getModuleId(a),i=null,j=c.get("lastShowItem"),k=!0;c._isModuleInitial(h)||(k=!1),i=c._getModule(h),b=b||$(c.get("navItems")[a]),b.hasClass(o)&&j&&(c._setLastItem(b[0]),c._setSelectHideItem(a)),d.removeClass(n),b.addClass(n),e.addClass(o),$(e[a]).removeClass(o),g=a,c.set("currentModelIndex",g),curPageId=c._getCurrentPageId(),f(h,curPageId),!curPageId&&i.homePage&&c._setPageSelected(a,i.homePage)}},_setPageSelected:function(a,b,c,e){var f=this,g=f._getModuleId(a)||a,h=f._getModule(g);if(h&&b){h.menu.setSelectedByField(b);var i=h.menu.getSelected(),j=h.tab,k="",l=-1;if(i&&i.get("id")===b)k=i.get("href"),k=e?d(k,e):k,h.tab.addTab({id:i.get("id"),title:i.get("text"),closeable:i.get("closeable"),href:k},!!c);else if(b){var m=b.replace("-","/");-1===m.indexOf("/")&&(m=g+"/"+m),-1===(l=b.indexOf("."))&&(m+=f.get("urlSuffix")),k=e?m+"?"+e:m,j.addTab({id:b,title:"",href:k},!!c)}}},_showHideList:function(a){var b=this,c=b.get("hideList");c.css("left",a.left),c.css("top",a.top),c.show()},_setSelectHideItem:function(a){var b=this,c=b.get("hideList"),d=b.get("hideItmes"),e=null,f=null,g=null,h=null;BUI.each(d,function(b){var c=$(b);c.attr(w)==a&&(f=b),c.hasClass(p)&&(e=b)}),e!==f&&(e&&(h=$(e).find(".dl-hide-current"),$(e).removeClass(p)),$(f).addClass(p),h||(h=new Node('<span class="dl-hide-current">&nbsp;&nbsp;</span>')),g=$(f),h.appendTo(g.children(".nav-item-inner")),g.prependTo(c))}}),m.MainPage=y});